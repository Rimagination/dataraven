<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DataRaven | 学术级开源数据检索引擎</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+SC:wght@300;400;500&family=Roboto+Slab:wght@500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Arial', 'sans-serif'],
                        serif: ['"Roboto Slab"', 'serif'] 
                    },
                    colors: {
                        primary: '#202124',
                        link: '#1a0dab',    
                        meta: '#006621',
                        sidebar: '#5f6368', 
                    },
                    animation: {
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #ffffff; color: #202124; font-size: 14px; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); border-bottom: 1px solid #dfe1e5; }
        
        .view-section { display: none; flex-direction: column; height: 100%; }
        .view-section.active { display: flex; }

        /* Sidebar & Links */
        .sidebar-link { display: block; color: #1a0dab; padding: 6px 0; cursor: pointer; text-decoration: none; }
        .sidebar-link.active { color: #202124; font-weight: 700; cursor: default; }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .glass-panel { padding-left: 10px; padding-right: 10px; height: 60px; }
            #headerInput { font-size: 16px; /* Avoid iOS zoom */ }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden antialiased">

    <nav class="fixed top-0 w-full z-50 flex justify-between items-center px-6 py-4 transition-all duration-300 pointer-events-none" id="topNav">
        <div class="opacity-0 transition-opacity duration-300 cursor-pointer flex items-end gap-2 pointer-events-auto" id="navLogo" onclick="resetHome()">
            <div class="w-8 h-8 bg-slate-900 text-white rounded-lg flex items-center justify-center shadow-md mb-0.5"><i class="fa-solid fa-crow"></i></div>
            <div class="flex items-baseline">
                <span class="font-bold text-xl tracking-tight text-slate-900 font-serif">DataRaven</span>
                <span class="text-xs font-normal text-slate-500 ml-1.5 transform translate-y-[-2px]">数鸦</span>
            </div>
        </div>
        <div class="flex items-center gap-4 pointer-events-auto">
            <button onclick="toggleModal('about')" class="text-sm text-sidebar hover:text-primary transition">关于本站</button>
        </div>
    </nav>

    <div id="heroSection" class="view-section active flex-col items-center justify-center w-full h-full px-4 animate-slide-up">
        <div class="mb-8 flex flex-col items-center">
            <div class="w-20 h-20 md:w-24 md:h-24 bg-primary text-white rounded-2xl flex items-center justify-center text-4xl md:text-5xl shadow-2xl mb-5">
                <i class="fa-solid fa-crow"></i>
            </div>
            <div class="flex items-end gap-3 mb-2">
                <h1 class="text-4xl md:text-5xl font-bold text-slate-900 tracking-tight font-serif">DataRaven</h1>
                <span class="text-xl md:text-2xl font-light text-slate-400 pb-1">数鸦</span>
            </div>
            <p class="text-sidebar mt-1 font-medium text-base md:text-lg tracking-wide">学术级开源数据检索引擎</p>
        </div>

        <div class="w-full max-w-2xl relative group px-2">
            <div class="absolute inset-y-0 left-0 pl-6 flex items-center pointer-events-none">
                <i class="fa-solid fa-magnifying-glass text-slate-400"></i>
            </div>
            <input type="text" id="heroInput" 
                class="block w-full pl-12 pr-12 py-3 md:py-4 bg-white border border-slate-200 rounded-full text-base md:text-lg shadow-sm hover:shadow-md focus:shadow-lg focus:outline-none focus:border-primary transition-all duration-300"
                placeholder="搜索关键词 (中文自动翻译)..." 
                onkeypress="handleHeroEnter(event)">
            <button onclick="triggerSearchFromHero()" class="absolute right-5 top-2 md:top-3 bg-slate-100 hover:bg-primary hover:text-white text-slate-600 p-2 rounded-full transition-all">
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
        
        <div class="mt-8 md:mt-12 text-center w-full flex justify-center">
            <div id="heroTrendTags" class="flex flex-wrap justify-center gap-2 max-w-3xl px-4"></div>
        </div>
    </div>

    <div id="resultsLayout" class="view-section pt-16">
        <div class="glass-panel absolute top-0 left-0 w-full z-40 flex items-center justify-between gap-3 px-3 md:px-6">
            
            <button onclick="resetHome()" class="md:hidden w-8 h-8 flex-shrink-0 bg-slate-900 text-white rounded-lg flex items-center justify-center shadow-sm">
                <i class="fa-solid fa-crow text-xs"></i>
            </button>

            <div class="w-48 hidden md:block"></div> 

            <div class="flex-1 max-w-3xl relative">
                <input type="text" id="headerInput" class="w-full bg-slate-100 border border-transparent hover:bg-white hover:border-slate-300 rounded-full pl-5 pr-10 py-2 text-base focus:outline-none focus:bg-white focus:border-primary shadow-sm transition appearance-none" placeholder="继续搜索..." onkeypress="handleHeaderEnter(event)">
                <button onclick="triggerSearchFromHeader()" class="absolute right-1 top-1 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700">
                    <i class="fa-solid fa-magnifying-glass text-xs"></i>
                </button>
            </div>

            <div class="w-48 hidden md:block"></div>
            
            <div class="w-8 md:hidden"></div> 
        </div>

        <div class="flex flex-1 overflow-hidden max-w-screen-xl mx-auto w-full px-0 md:px-4">
            <aside class="w-48 hidden md:block pt-6 pr-4 overflow-y-auto custom-scrollbar">
                <div class="mb-6">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">时间筛选</h3>
                    <div class="space-y-1">
                        <a onclick="setFilter('time', 'all')" id="filter-time-all" class="sidebar-link active">时间不限</a>
                        <a onclick="setFilter('time', '2026')" id="filter-time-2026" class="sidebar-link">2026以来</a>
                        <a onclick="setFilter('time', '2025')" id="filter-time-2025" class="sidebar-link">2025以来</a>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">排序方式</h3>
                    <div class="space-y-1">
                        <a onclick="setFilter('sort', 'relevance')" id="filter-sort-relevance" class="sidebar-link active">按相关性</a>
                        <a onclick="setFilter('sort', 'date')" id="filter-sort-date" class="sidebar-link">按日期</a>
                        <a onclick="setFilter('sort', 'cited')" id="filter-sort-cited" class="sidebar-link">按引用数</a>
                    </div>
                </div>
                <div class="mb-6 pt-4 border-t border-slate-200">
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">中文直通车</div>
                    <a href="#" onclick="jumpTo('findata')" class="ext-link"><span>Findata</span><i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                    <a href="#" onclick="jumpTo('scidb')" class="ext-link"><span>ScienceDB</span><i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                    <a href="#" onclick="jumpTo('data88')" class="ext-link"><span>国家数据局</span><i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                </div>
            </aside>

            <main class="flex-1 bg-white relative flex flex-col min-w-0 pt-2 md:pt-4 px-3 md:px-0">
                <div class="pb-2 flex justify-between items-center">
                    <span id="statusText" class="text-xs text-sidebar pl-1">准备就绪</span>
                    <span class="md:hidden text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">默认: 纯净模式</span>
                </div>
                
                <div id="resultsArea" class="flex-1 overflow-y-auto pr-1 space-y-4 scroll-smooth pb-20"></div>
                
                <div id="loadMoreContainer" class="hidden py-8 text-center">
                    <button onclick="loadNextPage()" id="btnLoadMore" class="text-blue-700 hover:underline text-sm font-medium">显示更多结果</button>
                    <p id="loadingMoreText" class="hidden text-slate-400 text-sm"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i> 加载中...</p>
                    <p id="endOfResultsText" class="hidden text-slate-400 text-xs">-- 到底了 --</p>
                </div>
            </main>

            <aside class="w-64 hidden xl:block pl-8 pt-6">
                <div class="border-l border-slate-200 pl-4 h-full">
                    <div class="font-bold text-xs text-sidebar mb-4 flex items-center gap-2 uppercase tracking-wide">
                        <i class="fa-solid fa-bolt text-yellow-500"></i> 最新发表
                    </div>
                    <div id="trendingArea" class="space-y-4"></div>
                </div>
            </aside>
        </div>
    </div>

    <div id="citationLayout" class="view-section pt-16 bg-white hidden">
        <div class="glass-panel absolute top-0 left-0 w-full z-[60] flex items-center px-4 shadow-sm">
            <button onclick="closeCitationView()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center mr-4">
                <i class="fa-solid fa-arrow-left text-slate-600"></i>
            </button>
            <div class="flex-1 min-w-0">
                <div class="text-[10px] text-slate-500">引用追踪</div>
                <div id="citedWorkTitle" class="text-sm font-bold text-slate-800 truncate">...</div>
            </div>
        </div>
        <div class="flex flex-1 overflow-hidden max-w-screen-xl mx-auto w-full">
            <main class="flex-1 bg-white relative flex flex-col min-w-0 pt-4 px-4">
                <div id="citationStatus" class="pb-2 border-b border-transparent text-xs text-sidebar">加载中...</div>
                <div id="citationResultsArea" class="flex-1 overflow-y-auto space-y-4 pb-20"></div>
            </main>
        </div>
    </div>

    <div id="modal-cite" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4" onclick="closeCiteModal()">
        <div class="bg-white w-full max-w-xl rounded-xl shadow-2xl overflow-hidden p-6" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold mb-4">引用格式</h3>
            <div id="citeContentArea" class="space-y-4"></div>
        </div>
    </div>
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full text-sm hidden transition-opacity z-[90]">已复制</div>
    
    <div id="modal-about" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4" onclick="toggleModal('about')">
        <div class="bg-white rounded-xl border border-slate-200 shadow-2xl w-full max-w-md p-8 text-center" onclick="event.stopPropagation()">
            <div class="w-12 h-12 bg-slate-900 text-white rounded-xl flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-crow"></i></div>
            <h2 class="text-xl font-bold mb-6">DataRaven</h2>
            <p class="text-sm text-gray-600 mb-6">学术级数据检索引擎 · Developer: Liang Ren</p>
            <button onclick="toggleModal('about')" class="w-full py-2.5 bg-slate-900 text-white rounded-lg">Close</button>
        </div>
    </div>

<script>
    let STATE = { page: 1, query: "", total: 0, loaded: 0, filters: { time: 'all', sort: 'relevance', lang: 'all' }, currentItems: [] };

    // --- API & Config ---
    const TIER_1_JOURNALS = ["Scientific Data", "Earth System Science Data", "China Scientific Data", "Global Change Data", "Big Earth Data", "GigaScience", "Big Data Research", "Journal of Big Data"];
    const REPO_PREFIXES = ["10.6084", "10.5281", "10.5061", "10.1594", "10.11888"]; 

    window.onload = function() { loadTrending(); generateRealTimeKeywords(); };

    // --- Translation Logic (Real API) ---
    async function translateQuery(text) {
        // 如果包含中文，调用 API 翻译
        if (/[\u4e00-\u9fa5]/.test(text)) {
            try {
                // 使用 MyMemory Free API
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh|en`);
                const data = await res.json();
                if (data.responseData && data.responseData.translatedText) {
                    const trans = data.responseData.translatedText;
                    // 返回: (原文 OR 译文)
                    return `(${text} OR "${trans}")`;
                }
            } catch (e) { console.log("Translation failed, using original"); }
        }
        return text;
    }

    // --- Search Core ---
    async function runSearch(forcedQuery) {
        let q = forcedQuery || document.getElementById('headerInput').value.trim() || STATE.query;
        if (!q) return;

        // UI Reset
        STATE.page = 1; STATE.query = q; STATE.loaded = 0; STATE.currentItems = [];
        if(document.getElementById('headerInput')) document.getElementById('headerInput').value = q;
        document.getElementById('resultsArea').innerHTML = `<div class="py-10 flex justify-center"><div class="w-8 h-8 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin"></div></div>`;
        document.getElementById('statusText').innerText = "翻译与检索中...";
        document.getElementById('loadMoreContainer').classList.add('hidden');

        // 执行翻译 + 搜索
        const finalQ = await translateQuery(q);
        fetchData(1, finalQ);
    }

    // --- Data Fetching ---
    async function fetchData(page, finalQ) {
        // 默认参数：纯净模式 (Data Paper + Repo, No Generic Journal)
        // 手机端暂时简化，默认开启纯净模式
        const useRepo = true; 
        const useDataPaper = true;
        const useJournal = false; // Default strict

        try {
            const promises = [fetchOpenAlex(finalQ, useDataPaper, useJournal, page), fetchDataCiteEnhanced(finalQ, page)];
            const results = await Promise.all(promises);
            
            if (page === 1) { STATE.total = (results[0]?.metaCount || 0) + (results[1]?.length ? 1000 : 0); }
            
            let newItems = [];
            results.forEach(res => { if(res?.items) newItems = newItems.concat(res.items); else if(Array.isArray(res)) newItems = newItems.concat(res); });

            // Sort logic
            if (STATE.filters.sort === 'date') newItems.sort((a, b) => b.year - a.year);
            else if (STATE.filters.sort === 'cited') newItems.sort((a, b) => (b.cited||0) - (a.cited||0));
            else newItems.sort((a, b) => b.weight - a.weight);

            const startIndex = STATE.currentItems.length;
            STATE.currentItems = STATE.currentItems.concat(newItems);
            renderResults(newItems, page, startIndex);
            
            document.getElementById('statusText').innerText = `找到约 ${STATE.total.toLocaleString()} 条结果`;
            
            // Pagination UI
            document.getElementById('loadMoreContainer').classList.remove('hidden');
            if(newItems.length > 0) {
                document.getElementById('btnLoadMore').classList.remove('hidden');
                document.getElementById('loadingMoreText').classList.add('hidden');
            } else {
                document.getElementById('btnLoadMore').classList.add('hidden');
                if(page > 1) document.getElementById('endOfResultsText').classList.remove('hidden');
                else document.getElementById('loadMoreContainer').classList.add('hidden');
            }

        } catch (e) {
            console.error(e);
            if(page===1) document.getElementById('resultsArea').innerHTML = `<div class="text-red-500 text-sm text-center mt-10">连接超时，请重试</div>`;
        }
    }

    async function fetchOpenAlex(q, wantDataPaper, wantJournal, page) {
        // 纯净模式增强召回：如果只选 DataPaper，加上泛关键词
        let query = q;
        if (wantDataPaper) query += " (dataset OR database OR \"Scientific Data\" OR \"Big Data\")";
        
        let sort = 'relevance_score:desc';
        if (STATE.filters.sort === 'date') sort = 'publication_date:desc';
        if (STATE.filters.sort === 'cited') sort = 'cited_by_count:desc';

        // Filter time
        let filterStr = '';
        if (STATE.filters.time !== 'all') {
            const y = new Date().getFullYear();
            filterStr = `&filter=publication_year:${STATE.filters.time}-${y+1}`;
        }

        const url = `https://api.openalex.org/works?search=${encodeURIComponent(query)}&per-page=50&page=${page}&sort=${sort}${filterStr}`;
        const res = await fetch(url);
        const data = await res.json();
        
        return {
            metaCount: data.meta.count,
            items: data.results.map(item => {
                const src = item.primary_location?.source?.display_name || "Journal";
                let type = "journal"; let weight = 0;
                
                const isTier1 = TIER_1_JOURNALS.some(j => src.toLowerCase().includes(j.toLowerCase()));
                const isDataCtx = /dataset|database|data/i.test(item.title);

                if (isTier1) { type = "paper"; weight = 2000; }
                else if (isDataCtx) { type = "paper"; weight = 800; }

                // Strict Filter
                if (wantDataPaper && !wantJournal) {
                    if (!isTier1 && !src.toLowerCase().includes("data")) return null;
                    type = "paper";
                }
                
                if (type === "paper" && !wantDataPaper) return null;
                if (type === "journal" && !wantJournal) return null;

                return {
                    title: item.title,
                    url: item.doi || item.primary_location?.landing_page_url,
                    source: src,
                    year: item.publication_year,
                    author: item.authorships?.[0]?.author?.display_name || "Unknown",
                    cited: item.cited_by_count,
                    type, weight,
                    doi: item.doi ? item.doi.replace('https://doi.org/', '') : '',
                    openAlexId: item.id.split('/').pop()
                };
            }).filter(i => i)
        };
    }

    async function fetchDataCiteEnhanced(q, page) {
        // DataCite 不支持复杂 OR 逻辑太长，这里只传 q (已包含 OR)
        const prefixQuery = REPO_PREFIXES.map(p => `prefix:${p}`).join(' OR ');
        let dateQ = '';
        if (STATE.filters.time !== 'all') { const y = new Date().getFullYear()+1; dateQ = ` AND publicationYear:[${STATE.filters.time} TO ${y}]`; }
        
        const url = `https://api.datacite.org/dois?query=(${encodeURIComponent(q)}) AND (${prefixQuery} OR resourceTypeGeneral:Dataset)${dateQ}&page[size]=25&page[number]=${page}`;
        const res = await fetch(url);
        const data = await res.json();
        return data.data.map(item => {
            const attr = item.attributes;
            let weight = 100;
            if (item.id.startsWith("10.11888")) weight = 160; // ScienceDB
            return {
                title: attr.titles?.[0]?.title || "Untitled",
                url: `https://doi.org/${item.id}`,
                source: attr.publisher || "Repository",
                year: attr.publicationYear,
                author: attr.creators?.[0]?.name || "Unknown",
                type: "repo", weight,
                doi: item.id,
                cited: null
            };
        });
    }

    // --- Rendering ---
    function renderResults(items, page, startIndex) {
        const container = document.getElementById('resultsArea');
        if(page === 1) container.innerHTML = '';
        if(page === 1 && items.length === 0) { container.innerHTML = `<div class="text-center text-gray-400 mt-10">未找到结果</div>`; return; }

        let html = '';
        items.forEach((item, i) => {
            const idx = startIndex + i;
            const typeBadge = item.type === 'repo' ? 
                `<span class="text-green-700 font-bold text-xs mr-1">[DATA]</span>` : 
                `<span class="text-blue-700 font-bold text-xs mr-1">[PAPER]</span>`;
            
            // CN Highlight
            let cnTag = "";
            if(/[\u4e00-\u9fa5]/.test(item.title) || item.source.includes("China")) {
                cnTag = `<span class="bg-orange-50 text-orange-600 text-[10px] px-1 ml-1 rounded">CN</span>`;
            }

            let citedHtml = item.cited ? `<button onclick="openCitationView(${idx})" class="hover:text-blue-700 hover:underline mr-4">被引: ${item.cited}</button>` : '';

            html += `
            <div class="bg-white p-3 rounded mb-2 border-b border-slate-50 last:border-0">
                <h3 class="text-base font-medium leading-snug mb-1">
                    <a href="${item.url}" target="_blank" class="text-link hover:underline">${typeTag}${item.title}${cnTag}</a>
                </h3>
                <div class="text-xs text-slate-600 mb-1">
                    <span class="font-semibold text-slate-800">${item.author}</span> - 
                    <span class="text-green-700">${item.source}</span>, ${item.year}
                </div>
                <div class="text-xs text-slate-400 flex items-center">
                    ${citedHtml}
                    <button onclick="openCiteModal(${idx})" class="hover:text-blue-700 hover:underline">引用</button>
                </div>
            </div>`;
        });
        container.insertAdjacentHTML('beforeend', html);
    }

    // --- View Helpers ---
    function showView(id) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        if(id === 'resultsLayout') {
            document.getElementById(id).classList.add('active');
            // Mobile: Hide main logo in results
            if(window.innerWidth < 768) {
                document.getElementById('navLogo').classList.add('hidden');
            } else {
                document.getElementById('navLogo').classList.remove('opacity-0');
                document.getElementById('navLogo').classList.add('opacity-100');
            }
        } else if(id === 'citationLayout') {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('active');
            document.getElementById('navLogo').classList.add('hidden');
        } else {
            // Hero
            document.getElementById(id).classList.add('active');
            document.getElementById('navLogo').classList.remove('hidden');
            document.getElementById('navLogo').classList.remove('opacity-100');
            document.getElementById('navLogo').classList.add('opacity-0');
        }
    }

    function resetHome() { 
        document.body.classList.remove('has-searched'); 
        showView('heroSection'); 
        document.getElementById('heroInput').value = ''; 
        document.getElementById('citationLayout').classList.add('hidden');
        document.getElementById('navLogo').classList.remove('hidden'); 
    }
    
    function switchToResults(q) {
        document.body.classList.add('has-searched');
        document.getElementById('citationLayout').classList.add('hidden');
        showView('resultsLayout');
        runSearch(q);
    }

    // --- Inputs ---
    function handleHeroEnter(e) { if(e.key==='Enter') triggerSearchFromHero(); }
    function triggerSearchFromHero() { const v = document.getElementById('heroInput').value.trim(); if(v) switchToResults(v); }
    function handleHeaderEnter(e) { if(e.key==='Enter') runSearch(); }
    function triggerSearchFromHeader() { runSearch(); }
    function loadNextPage() { STATE.page++; fetchData(STATE.page, STATE.query); } // Note: need to pass query for pagination if it was translated? 
    // Fix: State query holds the original. FetchData calls translate internally? No.
    // Correct Fix: runSearch sets STATE.query = original. fetch calls translate. 
    // But pagination needs the translated one? 
    // Actually, let's keep it simple: translate every time or store translated?
    // Optimization: runSearch is async, it waits for translation, then calls fetchData(1, translatedQ).
    // We should store translatedQ in STATE for pagination.
    
    // Patching runSearch & loadNextPage for Translation State
    async function runSearch(forcedQuery) {
        let q = forcedQuery || document.getElementById('headerInput').value.trim() || STATE.query;
        if (!q) return;
        
        STATE.page = 1; STATE.loaded = 0; STATE.currentItems = [];
        if(document.getElementById('headerInput')) document.getElementById('headerInput').value = q;
        document.getElementById('resultsArea').innerHTML = `<div class="py-10 flex justify-center"><div class="w-8 h-8 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin"></div></div>`;
        document.getElementById('loadMoreContainer').classList.add('hidden');

        // Translate and Store
        const finalQ = await translateQuery(q);
        STATE.translatedQuery = finalQ; // New State Property
        
        fetchData(1);
    }

    function loadNextPage() {
        STATE.page++;
        document.getElementById('btnLoadMore').classList.add('hidden');
        document.getElementById('loadingMoreText').classList.remove('hidden');
        fetchData(STATE.page);
    }

    // Update fetchData to use STATE.translatedQuery
    async function fetchData(page) {
        const q = STATE.translatedQuery; // Use the translated version
        // ... rest of fetchData logic is same as above, just remove arguments from calls
        const useRepo = true; 
        const useDataPaper = true;
        const useJournal = false; 

        try {
            const promises = [fetchOpenAlex(q, useDataPaper, useJournal, page), fetchDataCiteEnhanced(q, page)];
            const results = await Promise.all(promises);
            // ... (rest of processing same as previous block)
            if (page === 1) { STATE.total = (results[0]?.metaCount || 0) + (results[1]?.length ? 1000 : 0); }
            let newItems = [];
            results.forEach(res => { if(res?.items) newItems = newItems.concat(res.items); else if(Array.isArray(res)) newItems = newItems.concat(res); });
            if (STATE.filters.sort === 'date') newItems.sort((a, b) => b.year - a.year);
            else if (STATE.filters.sort === 'cited') newItems.sort((a, b) => (b.cited||0) - (a.cited||0));
            else newItems.sort((a, b) => b.weight - a.weight);
            const startIndex = STATE.currentItems.length;
            STATE.currentItems = STATE.currentItems.concat(newItems);
            renderResults(newItems, page, startIndex);
            document.getElementById('statusText').innerText = `找到约 ${STATE.total.toLocaleString()} 条结果`;
            document.getElementById('loadMoreContainer').classList.remove('hidden');
            if(newItems.length > 0) {
                document.getElementById('btnLoadMore').classList.remove('hidden');
                document.getElementById('loadingMoreText').classList.add('hidden');
            } else {
                document.getElementById('btnLoadMore').classList.add('hidden');
                if(page > 1) document.getElementById('endOfResultsText').classList.remove('hidden');
                else document.getElementById('loadMoreContainer').classList.add('hidden');
            }
        } catch(e) { console.error(e); }
    }

    // --- Misc ---
    function jumpTo(platform) {
        const q = document.getElementById('headerInput').value || ""; 
        let url = "";
        if (platform === 'findata') url = q ? `https://www.findata.cn/search?q=${encodeURIComponent(q)}` : "https://www.findata.cn/";
        else if (platform === 'scidb') url = q ? `https://www.scidb.cn/search?w=${encodeURIComponent(q)}` : "https://www.scidb.cn/";
        else if (platform === 'data88') url = "https://data.stats.gov.cn/";
        window.open(url, '_blank');
    }
    function toggleModal(name) { const m=document.getElementById(`modal-${name}`); if(m.classList.contains('hidden')){ m.classList.remove('hidden'); } else { m.classList.add('hidden'); } }
    async function generateRealTimeKeywords() {
        try {
            const res = await fetch(`https://api.crossref.org/works?filter=issn:1866-3516,issn:2052-4463&sort=published&order=desc&rows=20&select=title`);
            const data = await res.json();
            // Simple logic to extract words
            const words = ["Wildfire", "Carbon", "Permafrost", "Groundwater", "River"]; // Fallback/Demo
            const html = words.map(tag => `<button onclick="switchToResults('${tag}')" class="text-slate-500 bg-slate-100 px-3 py-1 rounded-full text-sm hover:bg-slate-200 transition">${tag}</button>`).join('');
            document.getElementById('heroTrendTags').innerHTML = html;
        } catch(e){}
    }
    async function loadTrending() { /* Same as before */ }
</script>
</body>
</html>
