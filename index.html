<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>DataRaven | 学术级开源数据检索引擎</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+SC:wght@300;400;500&family=Roboto+Slab:wght@500;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Arial', 'sans-serif'],
            serif: ['"Roboto Slab"', 'serif']
          },
          colors: {
            primary: '#202124',
            link: '#1a0dab',
            meta: '#006621',
            sidebar: '#5f6368',
            active: '#202124',
          },
          animation: {
            'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
          },
          keyframes: {
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #ffffff; color: #202124; font-size: 14px; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .glass-panel { background: rgba(255, 255, 255, 0.98); border-bottom: 1px solid #dfe1e5; }

    .view-section { display: none; flex-direction: column; height: 100%; }
    .view-section.active { display: flex; }

    /* Desktop Sidebar */
    .sidebar-group { margin-bottom: 20px; }
    .sidebar-link { display: block; color: #1a0dab; padding: 4px 0; cursor: pointer; text-decoration: none; }
    .sidebar-link:hover { text-decoration: underline; }
    .sidebar-link.active { color: #202124; font-weight: 700; text-decoration: none; cursor: default; }
    
    /* Date Inputs */
    .date-input { width: 60px; padding: 2px 4px; border: 1px solid #dfe1e5; border-radius: 4px; font-size: 13px; color: #202124; outline: none; }
    .date-input:focus { border-color: #1a0dab; }
    .date-btn { background: #1a0dab; color: white; border: none; border-radius: 4px; padding: 3px 8px; font-size: 12px; cursor: pointer; margin-left: 4px; }

    .type-label { display: flex; align-items: center; gap: 8px; padding: 4px 0; cursor: pointer; color: #3c4043; }
    .ext-link { display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; margin-bottom: 4px; border-radius: 4px; color: #3c4043; background: #f8f9fa; font-size: 13px; text-decoration: none; transition: background 0.2s; }
    .ext-link:hover { background: #e8f0fe; color: #1a0dab; }

    /* Citation modal */
    .cite-row { margin-bottom: 16px; }
    .cite-format { color: #5f6368; font-size: 13px; margin-bottom: 4px; }
    .cite-content { font-family: Arial, sans-serif; font-size: 14px; color: #202124; user-select: text; cursor: pointer; padding: 8px; background: #f8f9fa; border-radius: 4px; }

    /* Pager */
    .pager { display:flex; justify-content:center; align-items:center; gap: 6px; padding: 22px 0; user-select:none; }
    .pager-btn, .pager-page { border: 1px solid #e5e7eb; background: #fff; border-radius: 999px; padding: 6px 12px; font-size: 13px; color: #1a0dab; transition: background .15s; }
    .pager-btn:disabled { opacity:.35; cursor:not-allowed; }
    .pager-page.active { background:#1d4ed8; border-color:#1d4ed8; color:#fff; font-weight:700; cursor:default; }
    
    /* Mobile-Specific Tweaks */
    @media (max-width: 768px) {
        /* Result Item Spacing */
        .result-item { padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid #f3f4f6; }
        .result-item:last-child { border-bottom: none; }
        /* iOS Input Font Size Fix (Prevents Zoom) */
        input[type="text"] { font-size: 16px !important; }
    }
  </style>
</head>

<body class="h-screen flex flex-col overflow-hidden antialiased">

  <nav class="fixed top-0 w-full z-50 flex justify-between items-center px-4 md:px-6 py-4 transition-all duration-300 pointer-events-none" id="topNav">
    <div class="opacity-0 transition-opacity duration-300 cursor-pointer flex items-end gap-2 pointer-events-auto hidden md:flex" id="navLogo" onclick="resetHome()">
      <div class="w-8 h-8 bg-slate-900 text-white rounded-lg flex items-center justify-center shadow-md mb-0.5"><i class="fa-solid fa-crow"></i></div>
      <div class="flex items-baseline">
        <span class="font-bold text-xl tracking-tight text-slate-900 font-serif">DataRaven</span>
        <span class="text-xs font-normal text-slate-500 ml-1.5 transform translate-y-[-2px]">数鸦</span>
      </div>
    </div>
    <div class="flex items-center gap-4 pointer-events-auto ml-auto">
      <button onclick="toggleModal('about')" class="text-sm text-sidebar hover:text-primary transition bg-white/80 backdrop-blur px-3 py-1 rounded-full shadow-sm border border-slate-100 md:border-none md:shadow-none md:bg-transparent">关于本站</button>
    </div>
  </nav>

  <div id="heroSection" class="view-section active flex-col items-center justify-center w-full h-full px-4 animate-slide-up">
    <div class="mb-8 flex flex-col items-center">
      <div class="w-20 h-20 md:w-24 md:h-24 bg-primary text-white rounded-2xl flex items-center justify-center text-4xl md:text-5xl shadow-2xl mb-5">
        <i class="fa-solid fa-crow"></i>
      </div>
      <div class="flex items-end gap-3 mb-2">
        <h1 class="text-4xl md:text-5xl font-bold text-slate-900 tracking-tight font-serif">DataRaven</h1>
        <span class="text-xl md:text-2xl font-light text-slate-400 pb-1">数鸦</span>
      </div>
      <p class="text-sidebar mt-1 font-medium text-base md:text-lg tracking-wide text-center">学术级开源数据检索引擎</p>
    </div>

    <div class="w-full max-w-2xl relative group px-2 md:px-0">
      <div class="absolute inset-y-0 left-0 pl-6 flex items-center pointer-events-none">
        <i class="fa-solid fa-magnifying-glass text-slate-400 group-hover:text-primary transition"></i>
      </div>
      <input type="text" id="heroInput"
        class="block w-full pl-12 pr-12 py-3 md:py-4 bg-white border border-slate-200 rounded-full text-base md:text-lg shadow-sm hover:shadow-md focus:shadow-lg focus:outline-none focus:border-primary transition-all duration-300"
        placeholder="搜索关键词 (例如: Wildfire, GDP)..." onkeypress="handleHeroEnter(event)">
      <button onclick="triggerSearchFromHero()" class="absolute right-4 md:right-3 top-2 md:top-2.5 bg-slate-100 hover:bg-primary hover:text-white text-slate-600 p-2 rounded-full transition-all">
        <i class="fa-solid fa-arrow-right"></i>
      </button>
    </div>

    <div class="mt-8 md:mt-12 text-center w-full flex justify-center">
      <div id="heroTrendTags" class="flex flex-wrap justify-center gap-2 max-w-3xl px-2"></div>
    </div>
  </div>

  <div id="resultsLayout" class="view-section pt-14 md:pt-16">
    
    <div class="glass-panel absolute top-0 left-0 w-full h-14 md:h-16 z-40 flex items-center px-2 md:px-6 gap-2 md:gap-0">
      
      <button onclick="resetHome()" class="md:hidden w-9 h-9 flex-shrink-0 bg-slate-100 text-slate-600 rounded-full flex items-center justify-center active:scale-95 transition">
        <i class="fa-solid fa-arrow-left text-sm"></i>
      </button>

      <div class="w-48 hidden md:block"></div>
      
      <div class="flex-1 max-w-3xl mx-auto relative">
        <input type="text" id="headerInput"
          class="w-full bg-slate-100 border border-transparent focus:bg-white hover:border-slate-300 rounded-full pl-4 md:pl-5 pr-10 py-2 text-base focus:outline-none focus:border-primary shadow-sm transition appearance-none"
          placeholder="继续搜索..." onkeypress="handleHeaderEnter(event)">
        <button onclick="triggerSearchFromHeader()"
          class="absolute right-1 top-1 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700">
          <i class="fa-solid fa-magnifying-glass text-xs"></i>
        </button>
      </div>
      
      <div class="w-48 hidden md:block"></div>
    </div>

    <div class="flex flex-1 overflow-hidden max-w-screen-xl mx-auto w-full px-0 md:px-4">
      <aside class="w-48 hidden md:block pt-6 pr-4 overflow-y-auto">
        <div class="sidebar-group">
          <div class="sidebar-link active" id="filter-time-all" onclick="setFilter('time', 'all')">时间不限</div>
          <div class="sidebar-link" id="filter-time-2026" onclick="setFilter('time', '2026')">2026以来</div>
          <div class="sidebar-link" id="filter-time-2025" onclick="setFilter('time', '2025')">2025以来</div>
          <div class="sidebar-link" id="filter-time-2022" onclick="setFilter('time', '2022')">2022以来</div>
          
          <div class="sidebar-link" id="custom-range-link" onclick="toggleCustomDate()">自定义范围...</div>
          <div id="custom-date-box" class="hidden mt-2 flex items-center gap-1">
             <input type="text" id="dateStart" class="date-input" placeholder="yyyy">
             <span class="text-slate-400">-</span>
             <input type="text" id="dateEnd" class="date-input" placeholder="yyyy">
             <button onclick="submitCustomDate()" class="date-btn"><i class="fa-solid fa-check"></i></button>
          </div>
        </div>

        <div class="sidebar-group">
          <div class="sidebar-title">排序方式</div>
          <div class="sidebar-link active" id="filter-sort-relevance" onclick="setFilter('sort', 'relevance')">按相关性排序</div>
          <div class="sidebar-link" id="filter-sort-date" onclick="setFilter('sort', 'date')">按日期排序</div>
          <div class="sidebar-link" id="filter-sort-cited" onclick="setFilter('sort', 'cited')">按引用数排序</div>
        </div>

        <div class="sidebar-group pt-4 border-t border-slate-200">
          <div class="sidebar-title">包含类型</div>
          <label class="type-label"><input type="checkbox" id="chkRepo" checked onchange="goToPage(1)" class="accent-blue-600"><span>公开数据文件</span></label>
          <label class="type-label"><input type="checkbox" id="chkDataPaper" checked onchange="goToPage(1)" class="accent-blue-600"><span>数据期刊</span></label>
          <label class="type-label"><input type="checkbox" id="chkJournal" onchange="goToPage(1)" class="accent-blue-600"><span>综合学术期刊</span></label>
        </div>

        <div class="sidebar-group pt-4 border-t border-slate-200">
          <div class="sidebar-title">中文数据直通车</div>
          <a href="#" onclick="jumpTo('findata')" class="ext-link"><span>Findata</span> <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
          <a href="#" onclick="jumpTo('data88')" class="ext-link"><span>国家数据局</span> <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
        </div>
      </aside>

      <main class="flex-1 bg-white relative flex flex-col min-w-0 pt-3 md:pt-4 px-3 md:px-4 md:pl-4">
        <div class="pb-2 border-b border-transparent flex justify-between items-center">
          <span id="statusText" class="text-xs text-sidebar">DataRaven 准备就绪</span>
          <span class="md:hidden text-[10px] text-slate-400 bg-slate-50 px-2 py-0.5 rounded border border-slate-100">默认: 智能排序</span>
        </div>

        <div id="resultsArea" class="flex-1 overflow-y-auto pr-1 md:pr-2 scroll-smooth pb-20 no-scrollbar"></div>

        <div id="pagerWrap" class="border-t border-slate-100 pb-24 md:pb-0">
          <div id="pager" class="pager hidden"></div>
        </div>
      </main>

      <aside class="w-64 hidden xl:block pl-8 pt-6">
        <div class="border-l border-slate-200 pl-4 h-full">
          <div class="font-bold text-xs text-sidebar mb-4 flex items-center gap-2 uppercase tracking-wide">
            <i class="fa-solid fa-bolt text-yellow-500"></i> 最新数据发表
          </div>
          <div id="trendingArea" class="space-y-4"></div>
        </div>
      </aside>
    </div>
  </div>

  <div id="modal-cite" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4" onclick="closeCiteModal()">
    <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
      <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
        <h3 class="text-base font-bold text-slate-800">引用格式 (Cite)</h3>
        <button onclick="closeCiteModal()" class="w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fa-solid fa-xmark text-slate-500"></i></button>
      </div>
      <div class="p-5" id="citeContentArea"></div>
      <div class="px-5 py-3 bg-slate-50 border-t border-slate-100 flex gap-4 text-xs font-medium text-blue-700">
        <button class="hover:underline">BibTeX</button>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-12 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg text-sm hidden transition-opacity z-[90]">已复制到剪贴板</div>

  <div id="modal-about" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[60] hidden transition-opacity opacity-0 flex items-center justify-center p-4" onclick="toggleModal('about')">
    <div class="bg-white rounded-xl border border-slate-200 shadow-2xl w-full max-w-md scale-95 transition-transform" onclick="event.stopPropagation()">
      <div class="p-8 text-center">
        <div class="w-14 h-14 bg-slate-900 text-white rounded-2xl flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg"><i class="fa-solid fa-crow"></i></div>
        <h2 class="text-xl font-bold mb-1 font-serif text-slate-900">DataRaven <span class="text-lg font-normal text-slate-500">数鸦</span></h2>
        
        <div class="text-left bg-slate-50 p-5 rounded-lg border border-slate-100 text-sm text-slate-600 space-y-3 mb-6 mt-6">
          <p class="font-bold text-slate-800 text-xs uppercase tracking-wide border-b border-slate-200 pb-2 mb-2">Data Sources</p>
          <ul class="list-disc pl-4 space-y-1.5 text-xs text-slate-600">
            <li><strong>Data Journals:</strong> Scientific Data, ESSD, Big Data Research etc.</li>
            <li><strong>Repositories:</strong> Figshare, Zenodo, Dryad, PANGAEA</li>
            <li><strong>China Data:</strong> ScienceDB (科学数据银行), CSCD</li>
          </ul>
          <p class="text-[10px] text-slate-400 pt-2 italic">* ScienceDB data is indexed via DataCite API.</p>
          
          <div class="border-t border-slate-200 pt-3 mt-3">
            <p class="font-bold text-slate-800 mb-1 text-xs">Developer</p>
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs"><i class="fa-solid fa-user"></i></div>
                <div class="text-xs">
                    <p class="font-medium text-slate-900">Liang Ren</p>
                    <p class="text-slate-400 font-mono scale-90 origin-left">rl23@mails.tsinghua.edu.cn</p>
                </div>
            </div>
          </div>
        </div>
        <button onclick="toggleModal('about')" class="w-full py-2.5 bg-slate-900 hover:bg-black text-white rounded-lg font-medium transition active:scale-95">关闭 (Close)</button>
      </div>
    </div>
  </div>

<script>
  let STATE = {
    page: 1,
    query: "",
    filters: { time: 'all', sort: 'relevance' },
    currentItems: [],
    totals: { rawAll: 0, filteredEst: 0 },
    perPage: { openalex: 50, datacite: 25 }
  };

  const TIER_1_JOURNALS = [
    "Scientific Data", "Earth System Science Data", "China Scientific Data", "中国科学数据",
    "Global Change Data", "Big Earth Data", "GigaScience", "Big Data Research", "Journal of Big Data",
    "International Journal of Digital Earth", "Data in Brief", "Biodiversity Data Journal", "Geoscience Data Journal"
  ];

  const REPO_PREFIXES = ["10.6084", "10.5281", "10.5061", "10.1594", "10.11888"];

  const CN_MAP = {
    "长江": "\"Yangtze River\" OR \"Changjiang\"", "黄河": "\"Yellow River\" OR \"Huanghe\"", "青藏高原": "\"Tibetan Plateau\" OR \"Qinghai-Tibet\"",
    "碳中和": "\"Carbon Neutrality\" OR \"Net Zero\"", "气候变化": "\"Climate Change\"", "遥感": "\"Remote Sensing\"",
    "生物多样性": "\"Biodiversity\"", "地下水": "\"Groundwater\"", "人工智能": "\"Artificial Intelligence\" OR \"AI\"",
    "深度学习": "\"Deep Learning\"", "机器学习": "\"Machine Learning\"", "神经网络": "\"Neural Networks\"",
    "大数据": "\"Big Data\"", "物联网": "\"Internet of Things\" OR \"IoT\"", "区块链": "\"Blockchain\"",
    "新冠": "\"COVID-19\" OR \"SARS-CoV-2\"", "病毒": "\"Virus\"", "基因组": "\"Genome\"", "蛋白质": "\"Protein\"",
    "癌症": "\"Cancer\"", "肿瘤": "\"Tumor\"", "农业": "\"Agriculture\"", "粮食": "\"Food Security\"",
    "水文": "\"Hydrology\"", "土壤": "\"Soil\"", "森林": "\"Forest\"", "海洋": "\"Ocean\"",
    "极地": "\"Polar\"", "南极": "\"Antarctic\"", "北极": "\"Arctic\"", "冰川": "\"Glacier\"",
    "经济": "\"Economy\"", "金融": "\"Finance\"", "贸易": "\"Trade\"", "城市": "\"Urban\"",
    "人口": "\"Population\"", "教育": "\"Education\"", "心理": "\"Psychology\"", "社会": "\"Social\"",
    "能源": "\"Energy\"", "电池": "\"Battery\"", "材料": "\"Material\"", "石墨烯": "\"Graphene\"",
    "量子": "\"Quantum\"", "纳米": "\"Nano\"", "半导体": "\"Semiconductor\"", "物理": "\"Physics\"",
    "化学": "\"Chemistry\"", "生物": "\"Biology\"", "地理": "\"Geography\"", "历史": "\"History\""
  };

  function $(id){ return document.getElementById(id); }

  function showView(viewId) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    $(viewId).classList.add('active');
    
    // Logo 逻辑：电脑端结果页显示，手机端结果页隐藏（防重叠）
    const logo = $('navLogo');
    if (viewId === 'resultsLayout') {
      if(window.innerWidth >= 768) {
          logo.classList.remove('opacity-0');
          logo.classList.add('opacity-100');
          logo.style.pointerEvents = 'auto';
          logo.classList.remove('hidden');
      } else {
          logo.classList.add('hidden'); 
      }
    } else {
      // 首页：显示 Logo (手机/电脑都显示，但手机端 TopNav 的 Logo 本来就是 hidden md:flex)
      logo.classList.remove('hidden');
      logo.classList.remove('opacity-100');
      logo.classList.add('opacity-0');
      logo.style.pointerEvents = 'none';
    }
  }

  function resetHome() {
    showView('heroSection');
    $('heroInput').value = '';
    $('heroInput').focus();
    $('pager').classList.add('hidden');
    $('resultsArea').innerHTML = '';
    $('statusText').innerText = 'DataRaven 准备就绪';
  }

  function switchToResults(query){
    showView('resultsLayout');
    $('headerInput').value = query;
    runSearch(query);
  }

  function jumpTo(platform) {
    const q = STATE.query || "";
    let url = "";
    if (platform === 'findata') url = q ? `https://www.findata.cn/search?q=${encodeURIComponent(q)}` : "https://www.findata.cn/";
    else if (platform === 'data88') url = "https://data.stats.gov.cn/";
    window.open(url, '_blank');
  }

  function toggleModal(name) {
    const m = $(`modal-${name}`);
    if (m.classList.contains('hidden')) {
      m.classList.remove('hidden');
      setTimeout(() => { m.classList.remove('opacity-0'); m.firstElementChild.classList.remove('scale-95'); }, 10);
    } else {
      m.classList.add('opacity-0');
      m.firstElementChild.classList.add('scale-95');
      setTimeout(() => m.classList.add('hidden'), 200);
    }
  }

  // --- Custom Date ---
  function toggleCustomDate() {
      const box = $('custom-date-box');
      if(box.classList.contains('hidden')) { box.classList.remove('hidden'); $('dateStart').focus(); } 
      else { box.classList.add('hidden'); }
  }
  function submitCustomDate() {
      const start = $('dateStart').value.trim();
      const end = $('dateEnd').value.trim();
      if (!start || !end) return;
      document.querySelectorAll(`[id^="filter-time-"]`).forEach(el => el?.classList.remove('active'));
      $('custom-range-link').classList.add('active');
      $('custom-range-link').innerText = `${start} - ${end}`;
      STATE.filters.time = `${start}-${end}`;
      goToPage(1);
  }

  function setFilter(type, value) {
    document.querySelectorAll(`[id^="filter-${type}-"]`).forEach(el => el?.classList.remove('active'));
    const target = $(`filter-${type}-${value}`);
    if (target) target.classList.add('active');
    if (type === 'time') {
        $('custom-range-link').classList.remove('active');
        $('custom-range-link').innerText = '自定义范围...';
        $('custom-date-box').classList.add('hidden');
        $('dateStart').value = ''; $('dateEnd').value = '';
    }
    STATE.filters[type] = value;
    goToPage(1);
  }

  // --- Citation ---
  function openCiteModal(index) {
    const item = STATE.currentItems[index];
    if (!item) return;
    const gbt = `[1] ${item.author||'Anon'}. ${item.title}. ${item.source||'Unknown'}, ${item.year}. DOI:${item.doi || ''}`;
    const apa = `${item.author||'Anon'}. (${item.year}). ${item.title}. ${item.source||'Unknown'}. ${item.doi ? `https://doi.org/${item.doi}` : ''}`.trim();
    $('citeContentArea').innerHTML = `
      <div class="cite-row" onclick="copyText('${gbt.replace(/'/g, "\\'")}')"><div class="cite-format">GB/T 7714</div><div class="cite-content">${gbt}</div></div>
      <div class="cite-row" onclick="copyText('${apa.replace(/'/g, "\\'")}')"><div class="cite-format">APA</div><div class="cite-content">${apa}</div></div>
    `;
    $('modal-cite').classList.remove('hidden');
  }
  function closeCiteModal(){ $('modal-cite').classList.add('hidden'); }
  function copyText(t) { navigator.clipboard.writeText(t).then(() => { const toast=$('toast'); toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'),2000); closeCiteModal(); }); }

  function expandQuery(q) {
    let finalQ = q;
    Object.keys(CN_MAP).forEach(cn => { if (finalQ.includes(cn)) finalQ = finalQ.replace(cn, `(${cn} OR ${CN_MAP[cn]})`); });
    return finalQ;
  }

  function handleHeroEnter(e){ if(e.key === 'Enter') triggerSearchFromHero(); }
  function triggerSearchFromHero(){ const val=$('heroInput').value.trim(); if(val) switchToResults(val); }
  function handleHeaderEnter(e){ if(e.key === 'Enter') runSearch(); }
  function triggerSearchFromHeader(){ runSearch(); }

  function runSearch(forcedQuery){
    let q = forcedQuery;
    if(!q && $('headerInput')) q = $('headerInput').value.trim();
    if(!q) q = STATE.query;
    if(!q) return;
    STATE.query = q;
    goToPage(1);
  }

  function renderPager(current, hasPrev, hasNext){
    const pager = $('pager');
    if(!pager) return;
    if (!STATE.currentItems || STATE.currentItems.length === 0) { pager.classList.add('hidden'); return; }
    pager.innerHTML = '';
    const btnPrev = document.createElement('button'); btnPrev.className = 'pager-btn'; btnPrev.textContent = '上一页'; btnPrev.disabled = !hasPrev; btnPrev.onclick = () => goToPage(current - 1); pager.appendChild(btnPrev);
    let start = Math.max(1, current - 4); let end = start + 9;
    if (current > 6) { start = current - 4; end = current + 5; }
    start = Math.max(1, start); end = start + 9;
    for(let p = start; p <= end; p++){ const b = document.createElement('button'); b.className = 'pager-page' + (p === current ? ' active' : ''); b.textContent = String(p); if (p !== current) b.onclick = () => goToPage(p); pager.appendChild(b); }
    const btnNext = document.createElement('button'); btnNext.className = 'pager-btn'; btnNext.textContent = '下一页'; btnNext.disabled = !hasNext; btnNext.onclick = () => goToPage(current + 1); pager.appendChild(btnNext);
    pager.classList.remove('hidden');
  }

  async function goToPage(page){
    if(page < 1) return;
    const useRepo = $('chkRepo').checked; const useDataPaper = $('chkDataPaper').checked; const useJournal = $('chkJournal').checked;
    if(!useRepo && !useDataPaper && !useJournal){ $('resultsArea').innerHTML = `<div class="text-gray-500 mt-10">请至少勾选一种类型进行检索。</div>`; $('statusText').innerText = `请选择类型`; $('pager').classList.add('hidden'); return; }
    STATE.page = page;
    $('resultsArea').innerHTML = `<div class="py-10"><div class="w-8 h-8 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin mb-4"></div></div>`;
    $('statusText').innerText = `正在检索...`;
    $('pager').classList.add('hidden');
    await fetchAndRenderPage(page);
  }

  async function fetchAndRenderPage(page){
    const useRepo = $('chkRepo').checked; const useDataPaper = $('chkDataPaper').checked; const useJournal = $('chkJournal').checked;
    const q = STATE.query.trim(); if(!q) return;
    const promises = [];
    if (useDataPaper || useJournal) promises.push(fetchOpenAlex(q, useDataPaper, useJournal, page));
    else promises.push(Promise.resolve({ items: [], metaCount: 0, received: 0, kept: 0 }));
    if (useRepo) promises.push(fetchDataCite(q, page));
    else promises.push(Promise.resolve({ items: [], metaTotal: 0, received: 0, kept: 0 }));
    const [oa, dc] = await Promise.all(promises);
    let items = [];
    if (oa.items?.length) items = items.concat(oa.items);
    if (dc.items?.length) items = items.concat(dc.items);
    if (STATE.filters.sort === 'date') items.sort((a,b)=> (b.year||0)-(a.year||0));
    else if (STATE.filters.sort === 'cited') items.sort((a,b)=> (b.cited||0)-(a.cited||0));
    else items.sort((a,b)=> (b.weight||0)-(a.weight||0));
    STATE.currentItems = items;
    if (page === 1) {
      const rawAll = (oa.metaCount || 0) + (dc.metaTotal || 0); STATE.totals.rawAll = rawAll;
      const receivedAll = (oa.received||0) + (dc.received||0); const keptAll = (oa.kept||0) + (dc.kept||0);
      if (keptAll === 0) { STATE.totals.filteredEst = 0; } else { const ratio = keptAll / Math.max(1, receivedAll); STATE.totals.filteredEst = Math.floor(rawAll * Math.max(0, Math.min(1, ratio))); }
    }
    renderResults(items, page);
    const raw = STATE.totals.rawAll || 0; const est = STATE.totals.filteredEst || 0;
    $('statusText').innerText = `找到约 ${raw.toLocaleString()} 条结果（过滤后估计 ${est.toLocaleString()} 条）`;
    if (!items || items.length === 0) { $('pager').classList.add('hidden'); return; }
    const hasPrev = page > 1; const hasNext = (oa.received === STATE.perPage.openalex && oa.kept > 0) || (dc.received === STATE.perPage.datacite && dc.kept > 0);
    renderPager(page, hasPrev, hasNext);
  }

  async function fetchOpenAlex(query, wantDataPaper, wantJournal, page){
    const expanded = expandQuery(query); let q = expanded;
    if (wantDataPaper) { q += ' (dataset OR database OR "data descriptor" OR "data paper" OR "Scientific Data")'; }
    const filters = [];
    if (STATE.filters.time !== 'all') {
      if (STATE.filters.time.includes('-')) { filters.push(`publication_year:${STATE.filters.time}`); } 
      else { const y = new Date().getFullYear(); filters.push(`publication_year:${STATE.filters.time}-${y+1}`); }
    }
    let sortParam = 'relevance_score:desc';
    if (STATE.filters.sort === 'date') sortParam = 'publication_date:desc';
    if (STATE.filters.sort === 'cited') sortParam = 'cited_by_count:desc';
    const filterStr = filters.length ? `&filter=${filters.join(',')}` : '';
    const url = `https://api.openalex.org/works?search=${encodeURIComponent(q)}&per-page=${STATE.perPage.openalex}&page=${page}&sort=${sortParam}${filterStr}`;
    try{
      const res = await fetch(url); const data = await res.json();
      const results = Array.isArray(data.results) ? data.results : [];
      const received = results.length;
      const items = results.map(item => {
        const src = item.primary_location?.source?.display_name || "Journal";
        let author = item.authorships?.[0]?.author?.display_name || "Unknown";
        if (item.authorships?.length > 1) author += " et al.";
        const title = item.title || ""; const year = item.publication_year || 0;
        const isTier1 = TIER_1_JOURNALS.some(j => src.toLowerCase().includes(j.toLowerCase()));
        const isDataContent = /dataset|database|data descriptor|inventory|benchmark|corpus|catalog/i.test(title);
        let type = "journal"; let label = "Article"; let weight = 0;
        if (isTier1) { type = "paper"; label = "Data Journal"; weight = 2000; }
        else if (isDataContent) { type = "paper"; label = "Data Paper"; weight = 800; }
        else { type = "journal"; label = "Article"; weight = 80; }
        if (wantDataPaper && !wantJournal) {
          if (!isTier1 && !src.toLowerCase().includes("data") && !isDataContent) return null;
          type = "paper"; if (!isTier1) { label = "Data Paper"; weight = Math.max(weight, 1200); }
        }
        if (type === "paper" && !wantDataPaper) return null;
        if (type === "journal" && !wantJournal) return null;
        const doi = item.doi ? item.doi.replace('https://doi.org/', '') : "";
        const urlOut = item.doi || item.primary_location?.landing_page_url || "";
        return { title, url: urlOut, source: src, year, author, cited: item.cited_by_count || 0, type, label, weight, doi };
      }).filter(Boolean);
      return { items, metaCount: data?.meta?.count || 0, received, kept: items.length };
    } catch(e){ return { items: [], metaCount: 0, received: 0, kept: 0 }; }
  }

  async function fetchDataCite(query, page){
    const expanded = expandQuery(query);
    const prefixQuery = REPO_PREFIXES.map(p => `prefix:${p}`).join(' OR ');
    let dateQuery = '';
    if (STATE.filters.time !== 'all') {
        if (STATE.filters.time.includes('-')) {
            const [start, end] = STATE.filters.time.split('-');
            dateQuery = ` AND publicationYear:[${start} TO ${end}]`;
        } else {
            const y = new Date().getFullYear() + 1;
            dateQuery = ` AND publicationYear:[${STATE.filters.time} TO ${y}]`;
        }
    }
    const finalQuery = `(${encodeURIComponent(expanded)}) AND (resourceTypeGeneral:Dataset OR (${prefixQuery}))${dateQuery}`;
    let sortParam = ''; if (STATE.filters.sort === 'date') sortParam = '&sort=-published';
    const url = `https://api.datacite.org/dois?query=${finalQuery}&page[size]=${STATE.perPage.datacite}&page[number]=${page}${sortParam}`;
    try{
      const res = await fetch(url); const data = await res.json();
      const rows = Array.isArray(data.data) ? data.data : []; const received = rows.length;
      const items = rows.map(row => {
        const attr = row.attributes || {}; const doi = row.id || ""; const publisher = attr.publisher || "Repository";
        const title = attr.titles?.[0]?.title || "Untitled"; let author = attr.creators?.[0]?.name || "Unknown";
        if (author.includes(',')) author = author.split(',').reverse().join(' ');
        let label = "Dataset"; let weight = 120;
        if (doi.startsWith("10.6084")) { label = "Figshare"; weight = 240; }
        else if (doi.startsWith("10.5281")) { label = "Zenodo"; weight = 220; }
        else if (doi.startsWith("10.5061")) { label = "Dryad"; weight = 220; }
        else if (doi.startsWith("10.1594")) { label = "PANGAEA"; weight = 230; }
        const isScienceDB = doi.startsWith("10.11888") || /ScienceDB|科学数据银行|scidb/i.test(publisher);
        if (isScienceDB) { label = "ScienceDB"; weight = 320; }
        const year = attr.publicationYear || 0;
        return { title, url: `https://doi.org/${doi}`, source: publisher, year, author, cited: null, type: "repo", label, weight, doi };
      });
      return { items, metaTotal: data?.meta?.total || 0, received, kept: items.length };
    } catch(e){ return { items: [], metaTotal: 0, received: 0, kept: 0 }; }
  }

  function renderResults(items, page){
    const container = $('resultsArea'); container.innerHTML = '';
    if (!items || items.length === 0) { container.innerHTML = `<div class="text-gray-500 mt-10">未找到符合条件的结果。<br><span class="text-xs">建议：放宽时间范围 / 尝试英文关键词 / 勾选更多类型</span></div>`; return; }
    let html = '';
    items.forEach((item, i) => {
      const idx = i;
      let typeTag = '';
      if (item.type === 'repo') typeTag = `<span class="text-green-700 font-bold text-xs mr-1">[DATA]</span>`;
      if (item.type === 'paper') typeTag = `<span class="text-blue-700 font-bold text-xs mr-1">[PAPER]</span>`;
      if (item.type === 'journal') typeTag = `<span class="text-slate-500 font-bold text-xs mr-1">[JOURNAL]</span>`;
      let sourceClass = "text-meta"; if (item.source && (item.source.includes("China") || item.source.includes("中国"))) sourceClass = "text-orange-600 font-bold";
      const citedHtml = (item.cited !== null && item.cited !== undefined) ? `<span class="text-gray-500">被引用次数：${item.cited}</span>` : ``;
      
      // Mobile tweak: add border for separation
      html += `
        <div class="result-item mb-6">
          <h3 class="text-lg leading-snug mb-1">
            <a href="${item.url || '#'}" target="_blank" class="text-link hover:underline font-medium">
              ${typeTag}${escapeHtml(item.title || '')}
            </a>
          </h3>
          <div class="text-sm text-gray-600 mb-1">
            <span class="font-medium text-gray-800">${escapeHtml(item.author || 'Unknown')}</span>
            -
            <span class="${sourceClass}">${escapeHtml(item.source || 'Unknown')}</span>, ${item.year || ''}
            ${item.doi ? ` - <span class="text-gray-500">DOI:${escapeHtml(item.doi)}</span>` : ''}
          </div>
          <div class="text-xs text-gray-500 flex gap-3 items-center">
            ${citedHtml}
            <button onclick="openCiteModal(${idx})" class="hover:text-blue-700 hover:underline flex items-center gap-1">
              <i class="fa-solid fa-quote-right"></i> 引用
            </button>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  function escapeHtml(str) { return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;'); }

  async function generateRealTimeKeywords() {
    const url = `https://api.crossref.org/works?filter=issn:1866-3516,issn:2052-4463&sort=published&order=desc&rows=50&select=title`;
    try { const res = await fetch(url); const data = await res.json(); const titles = (data?.message?.items || []).map(item => item.title?.[0]).filter(Boolean); const wordCount = {}; const STOP_WORDS = new Set(["the","and","of","in","a","for","to","with","on","dataset","data","database","global","analysis","study","high","resolution","time","series","china","world","model","change","during","over","system","using","based","from","assessment","spatial","temporal"]); titles.forEach(title => { const words = title.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/); words.forEach(word => { if (word.length > 3 && !STOP_WORDS.has(word) && isNaN(word)) { const cleanWord = word.charAt(0).toUpperCase() + word.slice(1); wordCount[cleanWord] = (wordCount[cleanWord] || 0) + 1; } }); }); const sortedWords = Object.entries(wordCount).sort((a,b) => b[1]-a[1]).slice(0,6).map(e => e[0]); $('heroTrendTags').innerHTML = sortedWords.map(tag => `<button onclick="switchToResults('${tag.replace(/'/g, "\\'")}')" class="text-gray-600 hover:text-blue-700 hover:bg-white bg-gray-100 px-4 py-1.5 rounded-full text-sm transition border border-transparent hover:border-gray-300 shadow-sm">${tag}</button>`).join(''); } catch(e) {}
  }

  async function loadTrending() {
    const area = $('trendingArea'); const url = `https://api.crossref.org/works?filter=issn:1866-3516,issn:2052-4463&sort=published&order=desc&rows=8`;
    try { const res = await fetch(url); const data = await res.json(); const items = data?.message?.items || []; let html = ''; items.forEach(item => { const title = item.title?.[0] || ''; const year = item.created?.['date-parts']?.[0]?.[0] || ''; const container = item['container-title']?.[0] || ''; const isESSD = container.includes("Earth System Science Data") || container.includes("System Science Data") || container.includes("System"); const badge = isESSD ? "ESSD" : "SciData"; html += `<a href="${item.URL}" target="_blank" class="block mb-3 group"><div class="text-blue-700 group-hover:underline text-sm font-medium line-clamp-2">${escapeHtml(title)}</div><div class="text-xs text-green-700">${badge} - ${year}</div></a>`; }); area.innerHTML = html; } catch(e) {}
  }

  window.onload = function(){ loadTrending(); generateRealTimeKeywords(); };
</script>
</body>
</html>
